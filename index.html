<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>APT Profile â€“ Template (Fixed Layout)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0b0f14;
      --panel: #121821;
      --muted: #9fb0c3;
      --text: #e6edf3;
      --accent: #4cc3ff;
      --chip: #1a2330;
      --bad: #c33;
      --ok: #2fa84f;
      --border: #243246;
      --card-bg: #0e141c;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: Inter, system-ui, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
    }
    
    a {
      color: var(--accent);
      text-decoration: none;
      transition: opacity 0.2s;
    }
    
    a:hover {
      opacity: 0.8;
    }
    
    header {
      position: sticky;
      top: 0;
      z-index: 50;
      background: linear-gradient(180deg, #0b0f14 0%, rgba(11,15,20,.85) 70%, rgba(11,15,20,0) 100%);
      backdrop-filter: saturate(1.2) blur(8px);
      border-bottom: 1px solid var(--border);
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 18px 20px;
    }
    
    .title {
      font-size: 28px;
      font-weight: 700;
      letter-spacing: .2px;
    }
    
    .aliases {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }
    
    .chip {
      background: var(--chip);
      color: var(--muted);
      border: 1px solid var(--border);
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
    }
    
    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
    }
    
    section {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 18px;
      margin-bottom: 20px;
    }
    
    section h2 {
      margin: 0 0 10px 0;
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .muted {
      color: var(--muted);
    }
    
    .two-col {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }
    
    @media (min-width: 768px) {
      .two-col {
        grid-template-columns: 1fr 1fr;
      }
    }
    
    .kbd {
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      background: var(--card-bg);
      border: 1px solid #223047;
      padding: 2px 6px;
      border-radius: 6px;
      color: #8fb7ff;
      font-size: 0.85em;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      border-spacing: 0;
    }
    
    th, td {
      border-bottom: 1px solid #223047;
      padding: 10px 8px;
      text-align: left;
      font-size: 14px;
    }
    
    th {
      color: #a7b6c8;
      font-weight: 600;
    }
    
    .cards {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }
    
    @media (min-width: 768px) {
      .cards {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    
    .card {
      background: var(--card-bg);
      border: 1px solid #223047;
      border-radius: 14px;
      padding: 14px;
    }
    
    .logo {
      height: 36px;
      width: 36px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #0b1017;
      border: 1px solid #223047;
      font-weight: bold;
      color: var(--accent);
    }
    
    .flex {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .small {
      font-size: 12px;
      color: var(--muted);
    }
    
    .foot {
      margin-top: 28px;
      color: #7f90a5;
      font-size: 12px;
      text-align: center;
    }
    
    .pill {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #223047;
      background: var(--card-bg);
      color: #93a7bf;
      font-size: 12px;
    }
    
    .scroll-x {
      overflow-x: auto;
    }
    
    .btn {
      display: inline-block;
      padding: 8px 12px;
      border: 1px solid #2a3b53;
      border-radius: 10px;
      background: #0f1722;
      color: #cfe7ff;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn:hover {
      background: #0d1420;
      transform: translateY(-1px);
    }
    
    .legend {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .legend .pill[data-lvl="low"] {
      border-color: #346e3b;
    }
    
    .legend .pill[data-lvl="medium"] {
      border-color: #8c6c2c;
    }
    
    .legend .pill[data-lvl="high"] {
      border-color: #8b2d2d;
    }
    
    footer {
      padding: 30px 0 60px;
    }
    
    .map-controls {
      position: relative;
      margin-top: 8px;
      display: flex;
      gap: 6px;
    }
    
    .btn-zoom {
      width: 36px;
      height: 32px;
      padding: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    
    #worldMap {
      background: #0c1118;
      border-radius: 12px;
      border: 1px solid #1e293b;
    }
    
    .error-banner {
      display: none;
      margin: 10px 0;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #5a2c2c;
      background: #2a1515;
      color: #ffd7d7;
    }
    
    .error-banner.show {
      display: block;
    }
    
    .map-fallback {
      display: none;
      margin-top: 8px;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px dashed #503d3d;
      background: #1a1414;
      color: #e6caca;
    }
    
    .tests {
      margin-top: 12px;
    }
    
    .tests li {
      list-style: none;
      margin: 4px 0;
      padding: 6px 8px;
      border-radius: 8px;
      background: var(--card-bg);
      border: 1px solid #223047;
    }
    
    .tests .ok {
      border-color: #214a2b;
      color: #9be69b;
    }
    
    .tests .bad {
      border-color: #5a2c2c;
      color: #ffb0b0;
    }
    
    /* Loading indicator */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: var(--accent);
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Status indicators */
    .status {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 6px;
    }
    
    .status.active {
      background-color: var(--ok);
    }
    
    .status.inactive {
      background-color: var(--bad);
    }
    
    /* Code blocks */
    code {
      background: var(--card-bg);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      font-size: 0.85em;
      color: #8fb7ff;
    }
    
    /* Improved table styling */
    table tr:hover {
      background-color: rgba(255,255,255,0.03);
    }
    
    /* Map container styling */
    #map-container {
      position: relative;
      width: 100%;
      height: 0;
      padding-bottom: 60%; /* Adjust map aspect ratio (60% ~ 3:2) */
      margin-top: 10px;
    }

    #map-container > svg {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    
    #legend {
      margin-top: 10px;
      font-family: Inter, Arial, sans-serif;
      display: flex;
      gap: 20px;
      justify-content: center;
      font-size: 14px;
      color: var(--muted);
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .legend-color {
      width: 16px;
      height: 16px;
      border-radius: 3px;
      display: inline-block;
    }

    .low    { background: #a6bddb; }
    .medium { background: #3690c0; }
    .high   { background: #034e7b; }
    
    /* Spinner */
    .spinner-border {
      width: 3rem;
      height: 3rem;
    }
    
    .visually-hidden {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
  </style>
  
  <!-- DataMaps dependencies -->
  <script src="https://d3js.org/d3.v3.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/1.6.9/topojson.min.js"></script>
  <script src="https://datamaps.github.io/scripts/datamaps.world.min.js"></script>
</head>
<body>
  <header>
    <div class="container">
      <div class="flex">
        <div class="logo">APT</div>
        <div>
          <div class="title" id="apt-title">APT Example</div>
          <div class="aliases" id="aliases">
            <span class="chip">UNCXXXX</span>
            <span class="chip">Dev-0193</span>
            <span class="chip">Wizard Sample</span>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main class="container" style="margin-top:10px">
    <div id="error" class="error-banner" role="alert" aria-live="polite"></div>

    <!-- Overview / Attribution cards -->
    <div class="cards">
      <section class="card">
        <h2>Overview / Summary</h2>
        <p id="overview" class="muted">APT Example is a financially motivated group active since 2023 targeting North America, Europe, and MENA with ransomware and data-theft operations.</p>
      </section>
      <section class="card">
        <h2>Attribution & Motivation</h2>
        <p><strong>Attribution:</strong> <span id="attribution">Suspected cybercrime syndicate (RU-speaking)</span></p>
        <p><strong>Motivation:</strong> <span id="motivation">Financial gain</span></p>
        <div class="legend" style="margin-top:6px">
          <span class="pill">Nationâ€‘state</span>
          <span class="pill">Financial</span>
          <span class="pill">Hacktivist</span>
        </div>
      </section>
      <section class="card">
        <h2>Highlights</h2>
        <ul id="highlights" class="muted" style="margin:6px 0 0 16px">
          <li>First observed: 2023-02 (phishing + VPN brute force)</li>
          <li>Leverages Living-off-the-Land (Rundll32, PowerShell, WMI)</li>
          <li>Ransomware double-extortion; public leak site</li>
        </ul>
      </section>
    </div>

    <!-- TTPs -->
    <section>
      <h2>Tactics, Techniques & Procedures (MITRE)</h2>
      <div class="scroll-x">
        <table id="ttps-table">
          <thead>
            <tr>
              <th>Tactic</th>
              <th>Technique</th>
              <th>ID</th>
              <th>Notes / Detection</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Initial Access</td>
              <td>Phishing</td>
              <td><span class="kbd">T1566.001</span></td>
              <td class="muted">Malicious attachments; macro lures</td>
            </tr>
            <tr>
              <td>Execution</td>
              <td>PowerShell</td>
              <td><span class="kbd">T1059.001</span></td>
              <td class="muted">Scripted staging & payload retrieval</td>
            </tr>
            <tr>
              <td>Persistence</td>
              <td>Registry Run Keys/Startup Folder</td>
              <td><span class="kbd">T1547</span></td>
              <td class="muted">Autoâ€‘start entries</td>
            </tr>
            <tr>
              <td>Credential Access</td>
              <td>OS Credential Dumping</td>
              <td><span class="kbd">T1003.001</span></td>
              <td class="muted">LSASS dump via comsvcs.dll</td>
            </tr>
            <tr>
              <td>Lateral Movement</td>
              <td>Remote Services (SMB/RDP)</td>
              <td><span class="kbd">T1021</span></td>
              <td class="muted">RDP with stolen creds</td>
            </tr>
            <tr>
              <td>Exfiltration</td>
              <td>Exfil to Cloud Storage</td>
              <td><span class="kbd">T1567.002</span></td>
              <td class="muted">Rclone to Mega/AnonFiles</td>
            </tr>
            <tr>
              <td>Impact</td>
              <td>Data Encrypted for Impact</td>
              <td><span class="kbd">T1486</span></td>
              <td class="muted">Ransomware payload</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Kill Chain 
    <section>
      <h2>Kill Chain & Unique Techniques</h2>
      <ol id="killchain" class="muted" style="margin-top:6px">
        <li>Reconnaissance</li>
        <li>Initial Access (phishing / exposed VPN)</li>
        <li>Execution & Privilege Escalation</li>
        <li>Credential Access & Discovery</li>
        <li>Lateral Movement</li>
        <li>Collection & Exfiltration</li>
        <li>Impact (encryption / exfiltration blackmail)</li>
      </ol>
      <div style="margin-top:10px">
        <span class="pill">Unique</span>
        <span class="pill">Livingâ€‘offâ€‘theâ€‘Land</span>
        <span class="pill">Zeroâ€‘Day</span>
      </div>
    </section> -->

    <!-- Victims Chart -->
    <section>
      <h2>Number of Victims (by Campaign)</h2>
      <div id="victimsChart" style="height:320px; background: #0c1118; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: var(--muted);">
        <div style="text-align: center;">
          <div style="font-size: 48px; margin-bottom: 10px;">ðŸ“Š</div>
          <div>Victims Chart - Interactive visualization would appear here</div>
        </div>
      </div>
    </section>

    <!-- Sectors Chart -->
    <section>
      <h2>Victimology â€“ Top Sectors</h2>
      <div id="sectorsChart" style="height:320px; background: #0c1118; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: var(--muted);">
        <div style="text-align: center;">
          <div style="font-size: 48px; margin-bottom: 10px;">ðŸ“ˆ</div>
          <div>Sectors Chart - Interactive visualization would appear here</div>
        </div>
      </div>
    </section>

    <!-- World Map -->
    <section>
      <div class="two-col">
        <div>
          <h2>Global Attack Activity</h2>
          <p class="muted">Heatâ€‘style choropleth. Hover for incidents; colors reflect intensity (low/medium/high).</p>
          <div class="legend" style="margin:8px 0 10px">
            <span class="pill" data-lvl="low">Low</span>
            <span class="pill" data-lvl="medium">Medium</span>
            <span class="pill" data-lvl="high">High</span>
          </div>
          <div id="map-fallback" class="map-fallback">World map unavailable (blocked CDN or offline). Charts still work. You can retry via the Diagnostics below.</div>
        </div>
        <div style="text-align:right">
          <a class="btn" href="#" id="download-json">Download JSON</a>
        </div>
      </div>
      
      <!-- Spinner -->
      <div id="spinner" style="display: flex; justify-content: center; margin-top: 20px;">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>
      
      <!-- Map Container -->
      <div id="map-container"></div>
      
      <!-- Legend -->
      <div id="legend">
        <div class="legend-item"><span class="legend-color low"></span>Low (1â€“99)</div>
        <div class="legend-item"><span class="legend-color medium"></span>Medium (100â€“199)</div>
        <div class="legend-item"><span class="legend-color high"></span>High (200+)</div>
      </div>
      
      <div class="map-controls" aria-label="Map Zoom Controls">
        <button id="map-zoom-in" class="btn btn-zoom" title="Zoom in">+</button>
        <button id="map-zoom-out" class="btn btn-zoom" title="Zoom out">âˆ’</button>
      </div>
    </section>

    <!-- Malware Analysis -->
    <section>
      <h2>Malware Analysis & Hashes</h2>
      <div class="scroll-x">
        <table id="hashes-table">
          <thead>
            <tr>
              <th>Family</th>
              <th>Variant</th>
              <th>Type</th>
              <th>MD5</th>
              <th>SHA1</th>
              <th>SHA256</th>
              <th>Notes</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>INC</td>
              <td>v2025.07</td>
              <td>Ransomware</td>
              <td><code>3f2ac2...</code></td>
              <td><code>72c65f...</code></td>
              <td><code>d0a1b5...</code></td>
              <td class="muted">Observed in Q3â€‘2025 campaign</td>
            </tr>
            <tr>
              <td>Cobalt Strike</td>
              <td>Beacon</td>
              <td>Loader</td>
              <td><code>c1b2a3...</code></td>
              <td><code>a0b1c2...</code></td>
              <td><code>ff12aa...</code></td>
              <td class="muted">Signed DLL sideload</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Malware Sample Links -->
    <section>
      <h2>Malware Sample Links</h2>
      <ul id="sample-links" class="muted" style="margin-left:16px">
        <li><a href="https://app.any.run/tasks/170f24cf-3e74-4371-bf1f-287e55f6ba73" target="_blank" rel="noopener">Any.Run task</a></li>
        <li><a href="https://www.virustotal.com/" target="_blank" rel="noopener">VirusTotal sample</a></li>
        <li><a href="https://cape.contextis.com/" target="_blank" rel="noopener">CAPE report</a></li>
      </ul>
      <div class="small" style="margin-top:10px">Examples: CAPE, Any.Run, VirusTotal, Hybridâ€‘Analysis</div>
    </section>

    <!-- Recommendations -->
    <section>
      <h2>Recommendations for Defenders</h2>
      <ul id="recs" class="muted" style="margin-left:16px">
        <li>Block LOLBins via AppLocker/WDAC; restrict PowerShell to Constrained Language Mode</li>
        <li>Hunt for suspicious RDP logons & Shadow Copy deletions</li>
        <li>Monitor for data egress anomalies (cloud storage, rclone userâ€‘agents)</li>
        <li>Backup offline; test restoration regularly; implement MFA on VPN/SSO</li>
      </ul>
    </section>

    <!-- References -->
    <section>
      <h2>Screenshots, Logos & References</h2>
      <ul id="refs" class="muted" style="margin-left:16px">
        <li><a href="https://www.mandiant.com/" target="_blank" rel="noopener">Mandiant report (example)</a></li>
        <li><a href="https://www.recordedfuture.com/" target="_blank" rel="noopener">Recorded Future intel (example)</a></li>
      </ul>
      <div class="small" style="margin-top:6px">Add onion links, vendor reports, and logos/screenshots here.</div>
    </section>

    <footer class="foot">
      Built for APT profiling â€¢ Edit the <span class="kbd">profileData</span> JSON below and commit to GitHub Pages.
    </footer>
  </main>

  <script>
    // === EDIT THIS OBJECT ONLY ===
    const profileData = {
      name: "APT Example",
      aliases: ["UNCXXXX", "Dev-0193", "Wizard Sample"],
      overview: "APT Example is a financially motivated group active since 2023 targeting North America, Europe, and MENA with ransomware and data-theft operations.",
      attribution: "Suspected cybercrime syndicate (RU-speaking)",
      motivation: "Financial gain",
      highlights: [
        "First observed: 2023-02 (phishing + VPN brute force)",
        "Leverages Living-off-the-Land (Rundll32, PowerShell, WMI)",
        "Ransomware double-extortion; public leak site"
      ],
      ttps: [
        { tactic:"Initial Access", technique:"Phishing", id:"T1566.001", notes:"Malicious attachments; macro lures" },
        { tactic:"Execution", technique:"PowerShell", id:"T1059.001", notes:"Scripted staging & payload retrieval" },
        { tactic:"Persistence", technique:"Registry Run Keys/Startup Folder", id:"T1547", notes:"Autoâ€‘start entries" },
        { tactic:"Credential Access", technique:"OS Credential Dumping", id:"T1003.001", notes:"LSASS dump via comsvcs.dll" },
        { tactic:"Lateral Movement", technique:"Remote Services (SMB/RDP)", id:"T1021", notes:"RDP with stolen creds" },
        { tactic:"Exfiltration", technique:"Exfil to Cloud Storage", id:"T1567.002", notes:"Rclone to Mega/AnonFiles" },
        { tactic:"Impact", technique:"Data Encrypted for Impact", id:"T1486", notes:"Ransomware payload" }
      ],
      killchain: [
        "Reconnaissance",
        "Initial Access (phishing / exposed VPN)",
        "Execution & Privilege Escalation",
        "Credential Access & Discovery",
        "Lateral Movement",
        "Collection & Exfiltration",
        "Impact (encryption / exfiltration blackmail)"
      ],
      victimsSeries: [
        { label: "Q1â€‘2025", value: 8 },
        { label: "Q2â€‘2025", value: 13 },
        { label: "Q3â€‘2025", value: 17 }
      ],
      sectors: [
        { sector: "Financial Services", pct: 34 },
        { sector: "Manufacturing", pct: 22 },
        { sector: "Government", pct: 18 },
        { sector: "Healthcare", pct: 15 },
        { sector: "Education", pct: 11 }
      ],
      countries: [
        { name: "United States", incidents: 17 },
        { name: "France", incidents: 5 },
        { name: "United Arab Emirates", incidents: 3 },
        { name: "Egypt", incidents: 4 },
        { name: "United Kingdom", incidents: 6 }
      ],
      hashes: [
        { family:"INC", variant:"v2025.07", type:"Ransomware", md5:"3f2ac2...", sha1:"72c65f...", sha256:"d0a1b5...", notes:"Observed in Q3â€‘2025 campaign" },
        { family:"Cobalt Strike", variant:"Beacon", type:"Loader", md5:"c1b2a3...", sha1:"a0b1c2...", sha256:"ff12aa...", notes:"Signed DLL sideload" }
      ],
      sampleLinks: [
        { label: "Any.Run task", url: "https://app.any.run/tasks/170f24cf-3e74-4371-bf1f-287e55f6ba73" },
        { label: "VirusTotal sample", url: "https://www.virustotal.com/" },
        { label: "CAPE report", url: "https://cape.contextis.com/" }
      ],
      recommendations: [
        "Block LOLBins via AppLocker/WDAC; restrict PowerShell to Constrained Language Mode",
        "Hunt for suspicious RDP logons & Shadow Copy deletions",
        "Monitor for data egress anomalies (cloud storage, rclone userâ€‘agents)",
        "Backup offline; test restoration regularly; implement MFA on VPN/SSO"
      ],
      references: [
        { label:"Mandiant report (example)", url:"https://www.mandiant.com/" },
        { label:"Recorded Future intel (example)", url:"https://www.recordedfuture.com/" }
      ]
    };

    // === DataMaps Implementation ===
    
    // ISO Alpha-2 to Alpha-3 mapping (full list)
    const alpha2to3 = {
      AF: "AFG", AX: "ALA", AL: "ALB", DZ: "DZA", AS: "ASM", AD: "AND", AO: "AGO", AI: "AIA",
      AQ: "ATA", AG: "ATG", AR: "ARG", AM: "ARM", AW: "ABW", AU: "AUS", AT: "AUT", AZ: "AZE",
      BS: "BHS", BH: "BHR", BD: "BGD", BB: "BRB", BY: "BLR", BE: "BEL", BZ: "BLZ", BJ: "BEN",
      BM: "BMU", BT: "BTN", BO: "BOL", BQ: "BES", BA: "BIH", BW: "BWA", BV: "BVT", BR: "BRA",
      IO: "IOT", BN: "BRN", BG: "BGR", BF: "BFA", BI: "BDI", KH: "KHM", CM: "CMR", CA: "CAN",
      CV: "CPV", KY: "CYM", CF: "CAF", TD: "TCD", CL: "CHL", CN: "CHN", CX: "CXR", CC: "CCK",
      CO: "COL", KM: "COM", CG: "COG", CD: "COD", CK: "COK", CR: "CRI", CI: "CIV", HR: "HRV",
      CU: "CUB", CW: "CUW", CY: "CYP", CZ: "CZE", DK: "DNK", DJ: "DJI", DM: "DMA", DO: "DOM",
      EC: "ECU", EG: "EGY", SV: "SLV", GQ: "GNQ", ER: "ERI", EE: "EST", ET: "ETH", FK: "FLK",
      FO: "FRO", FJ: "FJI", FI: "FIN", FR: "FRA", GF: "GUF", PF: "PYF", TF: "ATF", GA: "GAB",
      GM: "GMB", GE: "GEO", DE: "DEU", GH: "GHA", GI: "GIB", GR: "GRC", GL: "GRL", GD: "GRD",
      GP: "GLP", GU: "GUM", GT: "GTM", GG: "GGY", GN: "GIN", GW: "GNB", GY: "GUY", HT: "HTI",
      HM: "HMD", VA: "VAT", HN: "HND", HK: "HKG", HU: "HUN", IS: "ISL", IN: "IND", ID: "IDN",
      IR: "IRN", IQ: "IRQ", IE: "IRL", IM: "IMN", IL: "ISR", IT: "ITA", JM: "JAM", JP: "JPN",
      JE: "JEY", JO: "JOR", KZ: "KAZ", KE: "KEN", KI: "KIR", KP: "PRK", KR: "KOR", KW: "KWT",
      KG: "KGZ", LA: "LAO", LV: "LVA", LB: "LBN", LS: "LSO", LR: "LBR", LY: "LBY", LI: "LIE",
      LT: "LTU", LU: "LUX", MO: "MAC", MK: "MKD", MG: "MDG", MW: "MWI", MY: "MYS", MV: "MDV",
      ML: "MLI", MT: "MLT", MH: "MHL", MQ: "MTQ", MR: "MRT", MU: "MUS", YT: "MYT", MX: "MEX",
      FM: "FSM", MD: "MDA", MC: "MCO", MN: "MNG", ME: "MNE", MS: "MSR", MA: "MAR", MZ: "MOZ",
      MM: "MMR", NA: "NAM", NR: "NRU", NP: "NPL", NL: "NLD", NC: "NCL", NZ: "NZL", NI: "NIC",
      NE: "NER", NG: "NGA", NU: "NIU", NF: "NFK", MP: "MNP", NO: "NOR", OM: "OMN", PK: "PAK",
      PW: "PLW", PS: "PSE", PA: "PAN", PG: "PNG", PY: "PRY", PE: "PER", PH: "PHL", PN: "PCN",
      PL: "POL", PT: "PRT", PR: "PRI", QA: "QAT", RE: "REU", RO: "ROU", RU: "RUS", RW: "RWA",
      BL: "BLM", SH: "SHN", KN: "KNA", LC: "LCA", MF: "MAF", PM: "SPM", VC: "VCT", WS: "WSM",
      SM: "SMR", ST: "STP", SA: "SAU", SN: "SEN", RS: "SRB", SC: "SYC", SL: "SLE", SG: "SGP",
      SX: "SXM", SK: "SVK", SI: "SVN", SB: "SLB", SO: "SOM", ZA: "ZAF", GS: "SGS", SS: "SSD",
      ES: "ESP", LK: "LKA", SD: "SDN", SR: "SUR", SJ: "SJM", SZ: "SWZ", SE: "SWE", CH: "CHE",
      SY: "SYR", TW: "TWN", TJ: "TJK", TZ: "TZA", TH: "THA", TL: "TLS", TG: "TGO", TK: "TKL",
      TO: "TON", TT: "TTO", TN: "TUN", TR: "TUR", TM: "TKM", TC: "TCA", TV: "TUV", UG: "UGA",
      UA: "UKR", AE: "ARE", GB: "GBR", US: "USA", UM: "UMI", UY: "URY", UZ: "UZB", VU: "VUT",
      VE: "VEN", VN: "VNM", VG: "VGB", VI: "VIR", WF: "WLF", EH: "ESH", YE: "YEM", ZM: "ZMB",
      ZW: "ZWE"
    };

    function getFillKey(count) {
      if (count >= 200) return "high";
      if (count >= 100) return "medium";
      return "low";
    }

    function drawMap(mapData) {
      const map = new Datamap({
        element: document.getElementById("map-container"),
        responsive: true,
        fills: {
          defaultFill: "#1a2330",
          low: "#a6bddb",
          medium: "#3690c0",
          high: "#034e7b"
        },
        data: mapData,
        geographyConfig: {
          highlightFillColor: null,
          highlightBorderColor: "transparent",
          highlightBorderWidth: 0,
          popupTemplate: function(geo, data) {
            return data ?
              `<div class="hoverinfo" style="background: #121821; color: #e6edf3; padding: 8px; border-radius: 6px; border: 1px solid #243246;">${geo.properties.name}: ${data.value} incidents</div>` :
              `<div class="hoverinfo" style="background: #121821; color: #e6edf3; padding: 8px; border-radius: 6px; border: 1px solid #243246;">${geo.properties.name}: No data</div>`;
          },
          borderWidth: 0.5,
          borderColor: "#243246"
        },
        done: function(datamap) {
          datamap.svg.selectAll(".datamaps-subunit").on("click", function(geography) {
            const alpha3 = geography.id;
            alert(`Country clicked: ${geography.properties.name} (${alpha3}) - would navigate to country details`);
          });
        }
      });

      window.addEventListener("resize", () => map.resize());
    }

    // Initialize the map with our profile data
    function initializeMap() {
      const counts = {};
      
      // Convert our profile data countries to map format
      profileData.countries.forEach(country => {
        // Find the alpha3 code for this country
        let alpha3 = null;
        for (const [alpha2, code] of Object.entries(alpha2to3)) {
          // This is a simplified lookup - in a real implementation you'd want a proper country name to code mapping
          if (country.name.toLowerCase().includes(getCountryFromAlpha2(alpha2).toLowerCase())) {
            alpha3 = code;
            break;
          }
        }
        
        if (alpha3) {
          counts[alpha3] = country.incidents;
        }
      });

      const mapData = {};
      for (const [country, count] of Object.entries(counts)) {
        mapData[country] = {
          value: count,
          fillKey: getFillKey(count)
        };
      }

      drawMap(mapData);
      document.getElementById("spinner").style.display = "none";
      document.getElementById("map-fallback").style.display = "none";
    }

    // Helper function to get country name from alpha2 code
    function getCountryFromAlpha2(alpha2) {
      const countryMap = {
        "US": "United States", "FR": "France", "AE": "United Arab Emirates", 
        "EG": "Egypt", "GB": "United Kingdom"
      };
      return countryMap[alpha2] || alpha2;
    }

    // Initialize the map when the page loads
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(initializeMap, 500); // Small delay to ensure everything is loaded
    });

    // === Event Handlers ===
    document.addEventListener('click', (e)=>{
      if (e.target && e.target.id === 'download-json'){
        e.preventDefault();
        const blob = new Blob([JSON.stringify(profileData,null,2)], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; 
        a.download = `${profileData.name.replace(/\s+/g,'_').toLowerCase()}_profile.json`;
        document.body.appendChild(a); 
        a.click(); 
        a.remove(); 
        URL.revokeObjectURL(url);
      }
      
      if (e.target && e.target.id === 'btn-retry') { 
        e.preventDefault(); 
        document.getElementById("spinner").style.display = "flex";
        setTimeout(initializeMap, 500);
      }
    });
  </script>
</body>
</html>
